<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UniStrategist AI - ëª¨ì˜ ë…¼ìˆ </title>

<script src="https://unpkg.com/lucide@latest"></script>

<script>
    window.MathJax = {
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
        svg: { fontCache: 'global' }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

html, body { margin: 0; padding: 0; font-family: 'Inter', 'Pretendard', sans-serif; background: #f5f7fa; color: #333; overflow-x: hidden; }
* { box-sizing: border-box; } a { text-decoration: none; color: inherit; }

.navbar { width: 100%; padding: 12px 20px; background: #fff; border-bottom: 1px solid #e6e6e6; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
.nav-left { display: flex; align-items: center; gap: 10px; }
.logo-text { font-size: 20px; font-weight: 700; color: #000; }
.nav-menu { display: flex; gap: 10px; margin-left: 10px; }
.nav-menu a { font-size: 14px; font-weight: 500; color: #444; transition: color 0.2s; }
.nav-menu a.active { color: #6c47ff; font-weight: 700; }
.nav-right { display: flex; gap: 8px; }

.btn-outline { background: transparent; border: 1px solid #6c47ff; color: #6c47ff; padding: 6px 14px; border-radius: 8px; font-size: 14px; cursor: pointer; }
.btn-outline:hover { background: #f0edff; }
.btn { background: #6c47ff; color: white; padding: 6px 14px; border-radius: 8px; font-size: 14px; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
.btn:hover { background: #5a37e6; }
.btn:disabled { background: #a0a0a0; cursor: not-allowed; }

.container { max-width: 1200px; margin: 0 auto; padding: 40px 20px 80px; }
.page-title { text-align: center; font-size: 32px; font-weight: 800; margin-bottom: 10px; color: #222; }
.page-subtitle { text-align: center; color: #666; margin-bottom: 40px; font-size: 16px; }
.grid-container { display: grid; grid-template-columns: 320px 1fr; gap: 32px; } 

.analysis-card { background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #f0f0f0; margin-bottom: 24px; }
.card-padding { padding: 24px; }
.card-header { padding: 12px 20px; background: #fff; display: flex; justify-content: space-between; align-items: center; }

.upload-area { border: 2px dashed #e0e0e0; border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; background: white; margin-bottom: 24px; }
.upload-area:hover { border-color: #6c47ff; background: #f8f7ff; }
.upload-area.has-file { border-color: #6c47ff; background: #f0edff; }
.hidden { display: none !important; }

.input-group { margin-bottom: 16px; }
.input-label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 6px; }
.input-text { width: 100%; padding: 10px 16px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; background: #fff; }

.tab-container { display: flex; border-bottom: 1px solid #e0e0e0; }
.tab-btn { flex: 1; padding: 12px; font-size: 14px; font-weight: 600; color: #666; background: #f9fafb; border: none; cursor: pointer; }
.tab-btn.active { background: #fff; color: #6c47ff; border-bottom: 2px solid #6c47ff; }

.history-item { padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
.history-item:hover { background: #f9fafb; }
.history-item:last-child { border-bottom: none; }
.history-univ { font-weight: 700; font-size: 14px; color: #333; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;}
.history-date { font-size: 12px; color: #888; display:flex; justify-content:space-between; }
.badge-solved { background: #ecfdf5; color: #047857; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 700; }
.badge-unsolved { background: #f3f4f6; color: #6b7280; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 700; }
.badge-shared { background: #e0f2fe; color: #0284c7; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 700; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
.modal-overlay.active { opacity: 1; visibility: visible; }
.modal-window { background: white; width: 95%; max-width: 1000px; height: 90vh; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; transform: translateY(20px); transition: transform 0.3s ease; }
.modal-overlay.active .modal-window { transform: translateY(0); }
.modal-header { padding: 16px 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #fff; }
.modal-body { flex: 1; overflow-y: auto; padding: 30px; background: #f9fafb; }
.modal-footer { padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #fff; text-align: right; }

.problem-box { background: #fff; padding: 24px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 12px; line-height: 1.8; }
.answer-area { width: 100%; height: 200px; padding: 16px; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical; margin-bottom: 30px; font-family: inherit; }

@media (max-width: 900px) { .grid-container { grid-template-columns: 1fr; } .nav-menu { display: none; } }
</style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <svg style="width:26px; height:26px;" viewBox="0 0 24 24" fill="none">
            <path d="M12 3L1 9l11 6 9-4.9V17h2V9L12 3z" fill="#6c47ff"/>
            <path d="M11 21a4 4 0 008 0v-5l-8 4v1z" fill="#6c47ff" />
        </svg>
        <a href="/" class="logo-text" style="margin-left:8px;">UniStrategist AI</a>
        <div class="nav-menu">
            <a href="/">í™ˆ</a>
            <a href="/analysis">ìƒê¸°ë¶€ ë¶„ì„</a>
            <a href="/essay.html" class="active">ëª¨ì˜ ë…¼ìˆ </a>
            <a href="/special.html">íŠ¹ì„±í™”ê³  íŠ¹ë³„ ì „í˜•</a>
            <a href="univ.html">ëŒ€í•™ ëª¨ì§‘ ìš”ê°•</a>
        </div>
    </div>
    <div class="nav-right" id="nav-right">
        <a href="/login.html" class="btn-outline">ë¡œê·¸ì¸</a>
        <a href="/signup.html" class="btn">íšŒì›ê°€ì…</a>
    </div>
</nav>

<div class="container">
    <h1 class="page-title">AI ê¸°ì¶œ ë³€í˜• & ëª¨ì˜ ë…¼ìˆ </h1>
    <p class="page-subtitle">ëŒ€í•™ë³„ ë§ì¶¤ ë³€í˜• ë¬¸ì œ ìƒì„± ë° ë¶€ì •í–‰ìœ„ ë°©ì§€ ì‹œìŠ¤í…œì´ ì ìš©ëœ ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ì…ë‹ˆë‹¤.</p>

    <div class="grid-container">
        <div>
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".pdf" hidden>
                <div id="emptyState">
                    <i data-lucide="file-up" style="width:48px; height:48px; color:#d1d5db; margin-bottom:12px;"></i>
                    <p style="font-weight:600; color:#374151;">PDF ê¸°ì¶œë¬¸ì œ ì—…ë¡œë“œ</p>
                </div>
                <div id="fileState" class="hidden">
                    <div style="background:#f0edff; color:#6c47ff; width:40px; height:40px; border-radius:8px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px;">
                        <i data-lucide="file-check" style="width:20px;"></i>
                    </div>
                    <p id="fileName" style="font-size:14px; font-weight:600; color:#333; margin:0;"></p>
                    <button id="removeFileBtn" style="background:none; border:none; color:#ef4444; text-decoration:underline; cursor:pointer; margin-top:8px; font-size:12px;">íŒŒì¼ ì‚­ì œ</button>
                </div>
            </div>

            <div class="analysis-card card-padding">
                <h3 style="font-size:14px; font-weight:700; color:#374151; margin-bottom:16px;">
                    <i data-lucide="sliders" style="width:16px; height:16px; color:#6c47ff;"></i> ìƒì„± ì˜µì…˜
                </h3>
                
                <div class="input-group">
                    <label class="input-label">ì‹œí—˜ì§€ ì œëª© (ì„ íƒ)</label>
                    <input type="text" id="examTitle" class="input-text" placeholder="ì˜ˆ: 2025 ì—°ì„¸ëŒ€ íŒŒì´ë„ 1íšŒ">
                </div>

                <div class="input-group">
                    <label class="input-label">ëª©í‘œ ëŒ€í•™êµ</label>
                    <select id="targetUniv" class="input-text">
                        <option value="ì„œì›‹ëŒ€í•™êµ">ì„œìš¸ëŒ€í•™êµ</option>
                        <option value="ì—°ì„¸ëŒ€í•™êµ">ì—°ì„¸ëŒ€í•™êµ</option>
                        <option value="ê³ ë ¤ëŒ€í•™êµ">ê³ ë ¤ëŒ€í•™êµ</option>
                        <option value="ì„œê°•ëŒ€í•™êµ">ì„œê°•ëŒ€í•™êµ</option>
                        <option value="ì„±ê· ê´€ëŒ€í•™êµ">ì„±ê· ê´€ëŒ€í•™êµ</option>
                        <option value="í•œì–‘ëŒ€í•™êµ">í•œì–‘ëŒ€í•™êµ</option>
                        <option value="ì¤‘ì•™ëŒ€í•™êµ">ì¤‘ì•™ëŒ€í•™êµ</option>
                        <option value="ê²½í¬ëŒ€í•™êµ">ê²½í¬ëŒ€í•™êµ</option>
                        <option value="í•œêµ­ì™¸êµ­ì–´ëŒ€í•™êµ">í•œêµ­ì™¸êµ­ì–´ëŒ€í•™êµ</option>
                        <option value="ì„œìš¸ì‹œë¦½ëŒ€í•™êµ">ì„œìš¸ì‹œë¦½ëŒ€í•™êµ</option>
                        <option value="ì´í™”ì—¬ìëŒ€í•™êµ">ì´í™”ì—¬ìëŒ€í•™êµ</option>
                        <option value="ê±´êµ­ëŒ€í•™êµ">ê±´êµ­ëŒ€í•™êµ</option>
                        <option value="ë™êµ­ëŒ€í•™êµ">ë™êµ­ëŒ€í•™êµ</option>
                        <option value="í™ìµëŒ€í•™êµ">í™ìµëŒ€í•™êµ</option>
                        <option value="ìˆ™ëª…ì—¬ìëŒ€í•™êµ">ìˆ™ëª…ì—¬ìëŒ€í•™êµ</option>
                        <option value="êµ­ë¯¼ëŒ€í•™êµ">êµ­ë¯¼ëŒ€í•™êµ</option>
                        <option value="ìˆ­ì‹¤ëŒ€í•™êµ">ìˆ­ì‹¤ëŒ€í•™êµ</option>
                        <option value="ì„¸ì¢…ëŒ€í•™êµ">ì„¸ì¢…ëŒ€í•™êµ</option>
                        <option value="ë‹¨êµ­ëŒ€í•™êµ">ë‹¨êµ­ëŒ€í•™êµ</option>
                        <option value="KAIST">KAIST</option>
                        <option value="POSTECH">POSTECH</option>
                        <option value="ì„œìš¸êµìœ¡ëŒ€í•™êµ">ì„œìš¸êµìœ¡ëŒ€í•™êµ</option>
                        <option value="ì„œìš¸ê³¼í•™ê¸°ìˆ ëŒ€í•™êµ">ì„œìš¸ê³¼í•™ê¸°ìˆ ëŒ€í•™êµ</option>
                        <option value="ìœ¡êµ°ì‚¬ê´€í•™êµ">ìœ¡êµ°ì‚¬ê´€í•™êµ</option>
                        <option value="ê´‘ìš´ëŒ€í•™êµ">ê´‘ìš´ëŒ€í•™êµ</option>
                        <option value="ëª…ì§€ëŒ€í•™êµ">ëª…ì§€ëŒ€í•™êµ</option>
                        <option value="ìƒëª…ëŒ€í•™êµ">ìƒëª…ëŒ€í•™êµ</option>
                        <option value="ë•ì„±ì—¬ìëŒ€í•™êµ">ë•ì„±ì—¬ìëŒ€í•™êµ</option>
                        <option value="ë™ë•ì—¬ìëŒ€í•™êµ">ë™ë•ì—¬ìëŒ€í•™êµ</option>
                        <option value="ê°€ì²œëŒ€í•™êµ">ê°€ì²œëŒ€í•™êµ</option>
                        <option value="ì¸í•˜ëŒ€í•™êµ">ì¸í•˜ëŒ€í•™êµ</option>
                        <option value="ì¸ì²œëŒ€í•™êµ">ì¸ì²œëŒ€í•™êµ</option>
                        <option value="í•œì„±ëŒ€í•™êµ">í•œì„±ëŒ€í•™êµ</option>
                    </select>
                </div>
                <button id="generateBtn" class="btn" style="width:100%; padding:14px;" disabled>
                    <i data-lucide="sparkles" style="width:18px;"></i> ë³€í˜• ë¬¸ì œ ìƒì„±í•˜ê¸°
                </button>
                <div id="statusBox" class="status-box hidden">
                    <div id="statusIcon"><i data-lucide="loader-2" class="spin" style="color:#6c47ff;"></i></div>
                    <span id="statusMessage" style="font-size:14px; font-weight:500;">ì²˜ë¦¬ ì¤‘...</span>
                </div>
            </div>

            <div class="analysis-card" style="padding:0;">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchHistoryTab('my')">ë‚˜ì˜ ê¸°ë¡</button>
                    <button class="tab-btn" onclick="switchHistoryTab('public')">ê³µìœ  ë¬¸ì œ ì€í–‰</button>
                </div>
                <div class="card-header" style="border-top:none;">
                    <span id="listTitle" style="font-size:13px; font-weight:700; color:#333;">
                        <i data-lucide="history" style="width:13px;"></i> ë‚´ê°€ ìƒì„±í•œ ë¬¸ì œ
                    </span>
                    <button onclick="refreshCurrentTab()" style="background:none; border:none; cursor:pointer;" title="ìƒˆë¡œê³ ì¹¨">
                        <i data-lucide="refresh-cw" style="width:13px;"></i>
                    </button>
                </div>
                <div id="historyList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="rightPanel">
            <div id="viewIntro" class="analysis-card" style="height:600px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                <div style="background:#f8f7ff; padding:20px; border-radius:50%; margin-bottom:24px;">
                    <i data-lucide="pen-tool" style="width:48px; height:48px; color:#6c47ff;"></i>
                </div>
                <h2 style="font-size:20px; margin-bottom:12px;">ì‹¤ì „ ëª¨ì˜ê³ ì‚¬</h2>
                <p style="color:#6b7280;">
                    ë¬¸ì œë¥¼ ìƒì„±í•˜ê±°ë‚˜ ì¢Œì¸¡ ëª©ë¡ì—ì„œ ì„ íƒí•˜ì„¸ìš”.<br>
                    <span style="color:#ef4444; font-weight:600;">â€» ì‹œí—˜ ì¤‘ í™”ë©´ ì´íƒˆ ì‹œ 0ì  ì²˜ë¦¬ë©ë‹ˆë‹¤.</span>
                </p>
            </div>

            <div id="viewResult" class="hidden">
                <div class="analysis-card card-padding">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <h2 style="font-size:22px; font-weight:700;">ì±„ì  ê²°ê³¼</h2>
                        <button class="btn-outline" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
                    </div>
                    <div id="resultContent" style="background:#f9fafb; padding:24px; border-radius:12px; line-height:1.7; font-size:15px; white-space:pre-wrap;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="solveModal" class="modal-overlay">
    <div class="modal-window">
        <div class="modal-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <span id="modalTitle" class="modal-title">ì‹¤ì „ ëª¨ì˜ê³ ì‚¬</span>
                <div style="background:#f3f4f6; padding:4px 10px; border-radius:6px; display:flex; align-items:center; gap:6px; font-weight:600; font-size:14px;">
                    <i data-lucide="timer" style="width:16px;"></i> <span id="timer">01:40:00</span>
                </div>
                <div style="color:#ef4444; font-size:12px; font-weight:600; background:#fef2f2; padding:2px 8px; border-radius:4px;">
                    âš ï¸ í™”ë©´ ì´íƒˆ ê¸ˆì§€
                </div>
            </div>
            <button class="modal-close" onclick="closeSolveModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="questionsContainer" style="max-width:800px; margin:0 auto;"></div>
        </div>
        <div class="modal-footer">
            <button id="submitBtn" class="btn" style="padding:12px 24px; font-size:16px;">
                ë‹µì•ˆ ì œì¶œ <i data-lucide="check-circle" style="width:18px;"></i>
            </button>
        </div>
    </div>
</div>

<script>
    lucide.createIcons();

    const examDataCache = {}; 
    
    let currentFile = null;
    let generatedQuestions = [];
    let currentHistoryId = null;
    let currentMetaInfo = null;
    let currentTab = 'my';
    
    let timerInterval;
    let antiCheatTimeout; 
    let remainingTime = 100 * 60;
    let isExamActive = false;

    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const generateBtn = document.getElementById('generateBtn');
    const statusBox = document.getElementById('statusBox');
    const solveModal = document.getElementById('solveModal');

    fetch('/api/session').then(res => res.json()).then(data => {
        if(data.loggedIn){
            document.getElementById('nav-right').innerHTML = `
                <span style="font-weight:600; margin-right:10px; color:#333;">í™˜ì˜í•©ë‹ˆë‹¤, ${data.name}ë‹˜</span>
                <a href="/logout" class="btn-outline">ë¡œê·¸ì•„ì›ƒ</a>`;
            loadHistory();
        }
    }).catch(()=>{});

    function switchHistoryTab(tab) {
        currentTab = tab;
        const btns = document.querySelectorAll('.tab-btn');
        const title = document.getElementById('listTitle');
        btns[0].classList.toggle('active', tab==='my');
        btns[1].classList.toggle('active', tab==='public');
        
        if(tab==='my') {
            title.innerHTML = `<i data-lucide="history" style="width:13px;"></i> ë‚´ê°€ ìƒì„±í•œ ë¬¸ì œ`;
            loadHistory();
        } else {
            title.innerHTML = `<i data-lucide="globe" style="width:13px;"></i> ê³µìœ  ë¬¸ì œ ì€í–‰`;
            loadPublicExams();
        }
    }
    window.refreshCurrentTab = () => currentTab === 'my' ? loadHistory() : loadPublicExams();

    function processExamData(items) {
        const sortedAsc = items.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
        const counters = {};
        sortedAsc.forEach(item => {
            const key = item.target_univ;
            if(!counters[key]) counters[key] = 0;
            counters[key]++;
            item.vol = counters[key];
        });
        return sortedAsc.reverse();
    }

    async function loadHistory() {
        const list = document.getElementById('historyList');
        try {
            const res = await fetch('/api/essay-history');
            const data = await res.json();
            
            if(!data.success || !data.history.length) {
                list.innerHTML = `<div style="padding:30px; text-align:center; color:#999; font-size:13px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            const processed = processExamData(data.history);
            
            list.innerHTML = processed.map(item => {
                const cacheId = `my_${item.id}`;
                examDataCache[cacheId] = item;
                
                const date = new Date(item.created_at).toLocaleDateString();
                const isSolved = !!item.grading_result;
                const badge = isSolved ? `<span class="badge-solved">ì±„ì ì™„ë£Œ</span>` : `<span class="badge-unsolved">ë¯¸ì‘ì‹œ</span>`;
                const displayTitle = item.title || `${item.target_univ} (${item.vol}íšŒ)`;

                return `
                <div class="history-item" onclick="handleHistoryClick('${cacheId}')">
                    <div class="history-univ">
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px;">${displayTitle}</span> 
                        ${badge}
                    </div>
                    <div class="history-date">
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px;">${item.file_name}</span>
                        <span>${date}</span>
                    </div>
                </div>`;
            }).join('');
        } catch(e) { console.error(e); }
    }

    async function loadPublicExams() {
        const list = document.getElementById('historyList');
        try {
            const res = await fetch('/api/public-exams');
            const data = await res.json();
            if(!data.exams.length) {
                list.innerHTML = `<div style="padding:30px; text-align:center; color:#999;">ê³µìœ ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            const processed = processExamData(data.exams);

            list.innerHTML = processed.map(item => {
                const cacheId = `pub_${item.id}`;
                examDataCache[cacheId] = item;
                const date = new Date(item.created_at).toLocaleDateString();
                const displayTitle = item.title || `${item.target_univ} (${item.vol}íšŒ)`;

                return `
                <div class="history-item" onclick="handlePublicClick('${cacheId}')">
                    <div class="history-univ">
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px;">${displayTitle}</span> 
                        <span class="badge-shared">ê³µìœ ë¨</span>
                    </div>
                    <div class="history-date"><span>${item.file_name}</span><span>${date}</span></div>
                </div>`;
            }).join('');
        } catch(e) {}
    }

    window.handleHistoryClick = function(cacheId) {
        const item = examDataCache[cacheId];
        if(!item) return;

        const questions = JSON.parse(item.questions_json);
        currentHistoryId = item.id; 
        currentMetaInfo = null;
        
        const title = item.title || `${item.target_univ} (${item.vol}íšŒ)`;

        if (item.grading_result) {
            if(confirm(`[${title}] ì´ë¯¸ ì±„ì ëœ ì‹œí—˜ì§€ì…ë‹ˆë‹¤.\ní™•ì¸: ë‹¤ì‹œ í’€ê¸° (ì¬ì‘ì‹œ)\nì·¨ì†Œ: ì±„ì  ê²°ê³¼ ë³´ê¸°`)) {
                startExam(questions, `${title} (ì¬ì‘ì‹œ)`);
            } else {
                showResult(item.grading_result);
            }
        } else {
            if(confirm(`[${title}] ë¬¸ì œë¥¼ ì§€ê¸ˆ í‘¸ì‹œê² ìŠµë‹ˆê¹Œ?`)) startExam(questions, title);
        }
    };

    window.handlePublicClick = function(cacheId) {
        const item = examDataCache[cacheId];
        if(!item) return;
        const title = item.title || `${item.target_univ} (${item.vol}íšŒ)`;
        if(!confirm(`[${title}] ê³µìœ  ë¬¸ì œë¥¼ í’€ì–´ë³´ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì œì¶œ ì‹œ 'ë‚˜ì˜ ê¸°ë¡'ì— ì €ì¥ë©ë‹ˆë‹¤.)`)) return;
        
        const questions = JSON.parse(item.questions_json);
        currentHistoryId = null; 
        currentMetaInfo = { targetUniv: item.target_univ, fileName: item.file_name, title: title };
        
        startExam(questions, `${title} (ê³µìœ )`);
    };

    function showResult(html) {
        document.getElementById('viewIntro').classList.add('hidden');
        document.getElementById('viewResult').classList.remove('hidden');
        document.getElementById('resultContent').innerHTML = html;
        if(window.MathJax) MathJax.typesetPromise();
    }

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        currentFile = file;
        document.getElementById('fileName').innerText = file.name;
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('fileState').classList.remove('hidden');
        uploadArea.classList.add('has-file');
        generateBtn.disabled = false;
    });

    document.getElementById('removeFileBtn').addEventListener('click', (e)=>{
        e.stopPropagation(); fileInput.value=''; currentFile=null;
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('fileState').classList.add('hidden');
        uploadArea.classList.remove('has-file');
        generateBtn.disabled = true;
    });

    const convertToBase64 = (f) => new Promise((res, rej) => {
        const r = new FileReader(); r.readAsDataURL(f);
        r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej;
    });

    generateBtn.addEventListener('click', async () => {
        if(!currentFile) return;
        const targetUniv = document.getElementById('targetUniv').value;
        const userTitle = document.getElementById('examTitle').value;

        try {
            generateBtn.disabled = true;
            statusBox.classList.remove('hidden');
            const base64 = await convertToBase64(currentFile);
            
            const res = await fetch('/api/generate-essay-auto', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ 
                    pdfBase64:base64, 
                    fileName:currentFile.name, 
                    targetUniv, 
                    title: userTitle 
                })
            });
            const data = await res.json();
            if(!data.success) throw new Error(data.error);

            statusBox.classList.add('hidden');
            currentHistoryId = data.historyId;
            currentMetaInfo = null;
            loadHistory();
            
            const finalTitle = userTitle || `${targetUniv} ì‹¤ì „ ëª¨ì˜ê³ ì‚¬`;
            startExam(data.questions, finalTitle);

        } catch(e) { 
            alert(e.message); statusBox.classList.add('hidden'); generateBtn.disabled=false; 
        }
    });

    function startExam(questions, title) {
        cleanupExam();

        generatedQuestions = questions;
        document.getElementById('modalTitle').innerText = title;
        
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';
        questions.forEach((q, idx) => {
            container.innerHTML += `
                <div style="margin-bottom:30px;">
                    <div class="problem-box"><strong>[ë¬¸ì œ ${idx+1}]</strong><br><br>${q.replace(/\n/g,'<br>')}</div>
                    <textarea class="answer-area" id="answer_${idx}" placeholder="ë‹µì•ˆ ì…ë ¥"></textarea>
                </div>`;
        });
        if(window.MathJax) MathJax.typesetPromise();

        solveModal.classList.add('active');
        remainingTime = 100 * 60;
        isExamActive = true;
        startTimer();

        antiCheatTimeout = setTimeout(() => {
            if(isExamActive) {
                document.addEventListener('visibilitychange', handleVisibilityChange);
                window.addEventListener('blur', handleWindowBlur);
                console.log("ë¶€ì •í–‰ìœ„ ê°ì§€ ì‹œì‘ë¨");
            }
        }, 3000); 
    }

    function handleVisibilityChange() {
        if(isExamActive && document.hidden) {
            triggerCheatingPenalty("íƒ­ ì „í™˜(í™”ë©´ ê°€ë¦¼)");
        }
    }

    function handleWindowBlur() {
        if(isExamActive) {
            triggerCheatingPenalty("ì°½ ì´íƒˆ(ì™¸ë¶€ í´ë¦­)");
        }
    }

    function triggerCheatingPenalty(reason) {
        if (!isExamActive) return;

        isExamActive = false; 
        alert(`ğŸš¨ ë¶€ì •í–‰ìœ„ ê°ì§€!\nì‚¬ìœ : ${reason}\n\nê·œì •ì— ë”°ë¼ 0ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©° ì¦‰ì‹œ ì œì¶œë©ë‹ˆë‹¤.`);
        submitExam(true); 
    }

    function closeSolveModal() {
        if(isExamActive) {
            if(!confirm("ì‹œí—˜ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‘ì„± ì¤‘ì¸ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")) return;
        }
        cleanupExam();
        solveModal.classList.remove('active');
    }

    function cleanupExam() {
        isExamActive = false;
        clearInterval(timerInterval);
        clearTimeout(antiCheatTimeout);
        document.removeEventListener('visibilitychange', handleVisibilityChange);
        window.removeEventListener('blur', handleWindowBlur);
    }

    function startTimer() {
        clearInterval(timerInterval);
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            remainingTime--;
            if(remainingTime <= 0) {
                alert("ì‹œê°„ ì¢…ë£Œ. ìë™ ì œì¶œí•©ë‹ˆë‹¤.");
                submitExam(false);
            }
            updateTimerDisplay();
        }, 1000);
    }

    function updateTimerDisplay() {
        const h = String(Math.floor(remainingTime / 3600)).padStart(2, '0');
        const m = String(Math.floor((remainingTime % 3600) / 60)).padStart(2, '0');
        const s = String(remainingTime % 60).padStart(2, '0');
        document.getElementById('timer').innerText = `${h}:${m}:${s}`;
    }

    document.getElementById('submitBtn').addEventListener('click', () => {
        if(confirm("ë‹µì•ˆì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) submitExam(false);
    });

    async function submitExam(isCheating) {
        cleanupExam();
        
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; 
        btn.innerText = isCheating ? "ë¶€ì •í–‰ìœ„ ì²˜ë¦¬ ì¤‘..." : "ì±„ì  ì¤‘...";

        const answers = generatedQuestions.map((q, i) => ({
            question: q,
            answer: document.getElementById(`answer_${i}`) ? document.getElementById(`answer_${i}`).value : ""
        }));

        try {
            const res = await fetch('/api/grade-essay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    qaPairs: answers, 
                    historyId: currentHistoryId, 
                    metaInfo: currentMetaInfo,
                    isCheating: isCheating 
                })
            });
            const data = await res.json();
            if(!data.success) throw new Error(data.error);

            solveModal.classList.remove('active');
            btn.disabled = false;
            btn.innerHTML = `ë‹µì•ˆ ì œì¶œ <i data-lucide="check-circle"></i>`;
            
            showResult(data.result);
            if(currentTab === 'my') loadHistory();
            else switchHistoryTab('my');

        } catch(e) {
            alert("ì œì¶œ ì˜¤ë¥˜: " + e.message);
            btn.disabled = false;
        }
    }
</script>
</body>
</html>